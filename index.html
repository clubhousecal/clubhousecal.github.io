<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Unofficial Clubhouse Show Calendar</title>
<style>
    :root{
        --bg1:#2c3e50;--bg2:#3498db;--card:rgba(255,255,255,.1);
        --text:#ecf0f1;--muted:rgba(236,240,241,.75);
        --accent:#3498db;--accent-weak:rgba(52,152,219,.3);
        --error:#e74c3c;--glass:rgba(0,0,0,.2);--glass-2:rgba(0,0,0,.3);
        --grid-gap:1px;--panel:#1f2a37;--panel-2:#0f172a;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
        font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh
    }
    .container{max-width:1200px;margin:0 auto;padding:20px}

    .header{text-align:center;margin-bottom:24px}
    .header h1{font-size:2.25rem;margin-bottom:.35rem;font-weight:600}
    .header p{opacity:.85;margin:.2rem 0}
    .header a{color:#fff;text-decoration:underline dotted}
    .meta{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:.35rem;opacity:.8;font-size:.9rem}

    .loading{text-align:center;padding:32px;font-size:18px;opacity:.8}
    .error{background:rgba(231,76,60,.2);border:1px solid rgba(231,76,60,.5);padding:12px;border-radius:8px;margin:16px 0}

    /* Sticky controls bar with blur */
    .controls{
        position:sticky; top:0; z-index:50;
        backdrop-filter: blur(6px);
        background:rgba(0,0,0,.35);
        padding:16px;border-radius:12px;margin:18px 0;display:grid;gap:12px
    }
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center}
    .search-wrap{position:relative}
    .search-bar{
        width:100%;padding:12px 40px 12px 14px;background:rgba(255,255,255,.1);
        border:1px solid rgba(255,255,255,.25);border-radius:8px;color:var(--text);font-size:16px
    }
    .search-bar::placeholder{color:rgba(236,240,241,.6)}
    .search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:.65}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .filters.collapsed{display:none}

    /* dropdowns */
    .filter-select{
      padding:10px 12px;background:var(--panel);
      border:1px solid rgba(255,255,255,.25);border-radius:8px;color:#ecf0f1;
      font-size:14px;min-width:130px;appearance:none;-webkit-appearance:none;-moz-appearance:none;
    }
    .filter-select:focus{outline:2px solid rgba(52,152,219,.6);outline-offset:2px}
    .filter-select option{background:var(--panel-2);color:#ecf0f1}

    /* multi-select (Genre) */
    .multi{position:relative}
    .multi-btn{
      display:flex;align-items:center;gap:8px;cursor:pointer;
      background:var(--panel);border:1px solid rgba(255,255,255,.25);border-radius:8px;
      color:#ecf0f1;font-size:14px;min-width:180px;padding:10px 12px
    }
    .multi-btn:focus{outline:2px solid rgba(52,152,219,.6);outline-offset:2px}
    .multi-panel{
      position:absolute;top:110%;left:0;z-index:100;background:var(--panel-2);
      border:1px solid rgba(255,255,255,.2);border-radius:10px;min-width:240px;padding:8px;display:none;
      box-shadow:0 10px 24px rgba(0,0,0,.35);max-height:260px;overflow:auto
    }
    .multi.open .multi-panel{display:block}
    .multi-search{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.06);color:#ecf0f1;margin-bottom:6px}
    .multi-list{max-height:220px;overflow:auto;display:grid;gap:6px;padding-right:4px}
    .multi-item{display:flex;align-items:center;gap:8px}
    .multi-item input{accent-color:#3aa6ff}
    .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);padding:2px 8px;border-radius:999px;font-size:12px}

    .view-toggle{display:flex;gap:8px;justify-content:flex-end}
    .btn{
      padding:10px 14px;min-height:44px;
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);
      border-radius:10px;color:var(--text);cursor:pointer;transition:.2s
    }
    .btn:hover{background:var(--accent-weak)}
    .btn.active{background:var(--accent);border-color:var(--accent)}
    .btn.secondary{background:rgba(255,255,255,.08)}

    .monthbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-top:6px}
    .month-title{font-weight:700;letter-spacing:.3px}
    .is-list .monthbar{display:none;} /* hide nav in list view */

    /* segmented control for Month/Week */
    .mode-toggle{display:flex; gap:12px; align-items:center}
    .segmented{
      display:inline-flex;
      border:1px solid rgba(255,255,255,.25);
      border-radius:12px;
      overflow:hidden;
    }
    .seg-btn{
      padding:10px 16px;
      min-height:44px;
      background:transparent;
      border:0;
      color:var(--text);
      cursor:pointer;
    }
    .seg-btn + .seg-btn{ border-left:1px solid rgba(255,255,255,.25) }
    .seg-btn.active{ background:var(--accent) }

    /* Calendar containers */
    .calendar-scroll{width:100%}
    .calendar-grid{
        display:grid;grid-template-columns:repeat(7,1fr);gap:var(--grid-gap);
        background:var(--glass);border-radius:10px;overflow:hidden;margin-top:10px
    }
    /* Week mode reflows to vertical list; no horizontal scroll needed */
    .calendar-grid.week{
        display:grid;grid-template-columns:1fr;gap:12px;background:transparent;border-radius:0;overflow:visible
    }
    .week-day{background:rgba(255,255,255,.06);border-radius:10px;padding:10px}
    .week-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:700;opacity:.95}

    .calendar-header{background:var(--glass-2);padding:10px;text-align:center;font-weight:600;font-size:13px}
    .calendar-day{background:rgba(255,255,255,.06);min-height:120px;padding:8px;position:relative;display:flex;flex-direction:column;gap:4px}
    .calendar-day.muted{opacity:.4}
    .day-number{font-weight:700;opacity:.9;font-size:12px;margin-bottom:2px}
    .calendar-day.today{outline:2px solid var(--accent);outline-offset:-2px}
    .event-item{background:#9b59b6;color:#fff;padding:4px 6px;border-radius:6px;font-size:12px;cursor:pointer;transition:.15s;line-height:1.2}
    .event-item:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.35)}
    .event-chip{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;margin-left:6px;opacity:.95}

    .event-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:18px;margin-top:14px}
    .event-card{background:var(--card);border-radius:14px;overflow:hidden;transition:.2s;border:1px solid rgba(255,255,255,.12)}
    .event-card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(0,0,0,.3);border-color:rgba(52,152,219,.45)}

    /* PHOTO: show entire image (no crop) */
    .event-image{
      width:100%;
      height:auto;
      object-fit:contain;
      background:linear-gradient(135deg,#34495e,#2c3e50);
      max-height:420px;
      cursor:pointer
    }
    .event-content{padding:16px}
    .event-title{font-size:1.15rem;font-weight:700;margin-bottom:4px}
    .event-date{color:var(--accent);font-weight:600;margin:6px 0 10px}
    .event-description{color:var(--muted);line-height:1.55;margin:10px 0}
    .event-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
    .detail-item{display:flex;justify-content:space-between;gap:8px}
    .detail-label{opacity:.7}
    .detail-value{color:var(--accent)}
    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .link{padding:8px 12px;background:rgba(52,152,219,.18);border:1px solid rgba(52,152,219,.35);border-radius:10px;
        color:var(--accent);text-decoration:none;font-size:13px;transition:.15s}
    .link:hover{background:rgba(52,152,219,.3);transform:translateY(-1px)}
    .hidden{display:none}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
    .modal{max-width:820px;width:100%;background:rgba(25,32,45,.95);border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:rgba(255,255,255,.06)}
    .modal-title{font-weight:700}
    .modal-close{border:0;background:transparent;color:#fff;font-size:20px;cursor:pointer;opacity:.8}
    .modal-body{padding:16px}
    .modal-grid{display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:start}
    .modal-img{
      width:100%;height:auto;object-fit:contain;max-height:70vh;
      background:linear-gradient(135deg,#34495e,#2c3e50);border-radius:10px
    }

    /* Mobile tweaks */
    .mobile-only{display:none}
    .desktop-only{display:inline-flex}
    @media(max-width:768px){
        .header h1{font-size:1.8rem}
        .desktop-only{display:none}
        .mobile-only{display:inline-flex}
        .controls{border-radius:0;margin:0 -20px 10px;padding:12px 20px}

        /* Make topbar stack and search field full-width on mobile */
        .topbar{display:flex;flex-direction:column;align-items:stretch;gap:10px}
        .search-wrap{width:100%}
        .view-toggle{justify-content:flex-start}

        .calendar-day{min-height:90px;padding:6px}
        .event-cards{grid-template-columns:1fr}
        .modal-grid{grid-template-columns:1fr}
        .event-image{max-height:70vh}
        .multi-panel{
          position:fixed;left:0;right:0;bottom:0;top:auto;z-index:1000;
          border-radius:14px 14px 0 0;max-height:70vh;min-width:auto;margin:0 12px 12px
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header" role="banner">
        <h1>Unofficial Clubhouse Show Calendar</h1>
        <p>To add your show, use <a href="https://docs.google.com/forms/d/e/1FAIpQLSdwCbm_GQvwf2o8a5i31Y_Sch4cKLl4Xdc1XHysh12XtFRdKA/viewform" target="_blank" rel="noopener">this form</a>.</p>
        <p>Corrections or suggestions: <a href="mailto:chousecal@gmail.com">chousecal@gmail.com</a></p>
        <div class="meta">
            <span id="lastUpdated" class="hidden"></span>
            <span id="tzLabel" class="hidden"></span>
        </div>
    </div>

    <div class="loading" id="loadingMessage">Loading events…</div>
    <div class="error hidden" id="errorMessage">Failed to load events. Please try again later.</div>

    <div id="controls" class="controls hidden" role="region" aria-label="Calendar controls">
        <div class="topbar">
            <div class="search-wrap">
                <input id="searchInput" type="search" class="search-bar" placeholder="Search for a show…" aria-label="Search shows"/>
                <span class="search-icon" aria-hidden="true">🔎</span>
            </div>

            <!-- Mobile Filters toggle -->
            <button class="btn secondary mobile-only" id="filtersToggleBtn" aria-expanded="false" aria-controls="filters">Filters</button>

            <div class="view-toggle" role="tablist" aria-label="View toggle">
                <button class="btn" id="listViewBtn" role="tab" aria-controls="listView">📋 List</button>
                <button class="btn active" id="calendarViewBtn" role="tab" aria-controls="calendarView" aria-selected="true">📅 Calendar</button>
            </div>
        </div>

        <div class="filters collapsed" id="filters">
            <select class="filter-select" id="stageFilter" aria-label="Filter by stage">
                <option value="">Stage</option>
            </select>

            <!-- Multi-select Genre -->
            <div class="multi" id="genreMulti">
              <button type="button" class="multi-btn" id="genreBtn" aria-haspopup="listbox" aria-expanded="false">
                <span id="genreBtnLabel">Genre (any)</span> ▼
              </button>
              <div class="multi-panel" id="genrePanel">
                <input type="text" class="multi-search" id="genreSearch" placeholder="Filter genres…" />
                <div class="multi-list" id="genreList" role="listbox" aria-multiselectable="true"></div>
              </div>
            </div>

            <select class="filter-select" id="dateFilter" aria-label="Quick date filter">
                <option value="">Date</option>
                <option value="today">Today</option>
                <option value="this-week">This Week</option>
                <option value="this-month">This Month</option>
            </select>

            <button class="btn secondary" id="clearFiltersBtn" title="Clear all filters">Clear Filters</button>
        </div>

        <div class="monthbar">
            <div class="btns">
                <button id="prevSpanBtn" class="btn" aria-label="Previous">← Prev</button>
                <button id="todayBtn" class="btn" aria-label="Jump to current">Today</button>
                <button id="nextSpanBtn" class="btn" aria-label="Next">Next →</button>
            </div>
            <div class="mode-toggle">
                <div class="month-title" id="monthLabel" aria-live="polite"></div>
                <div class="segmented" role="group" aria-label="Calendar display mode">
                    <button id="modeMonthBtn" class="seg-btn" type="button">Month</button>
                    <button id="modeWeekBtn"  class="seg-btn" type="button">Week</button>
                </div>
            </div>
        </div>
    </div>

    <div id="calendarView" class="hidden" role="region" aria-label="Calendar view">
        <div class="calendar-scroll" id="calendarScroll">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div id="listView" class="hidden" role="region" aria-label="List view">
        <div class="event-cards" id="eventCards"></div>
    </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modal-head">
      <div id="modalTitle" class="modal-title">Event</div>
      <button class="modal-close" id="modalClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
/* =============== State =============== */
let events = [];
let filteredEvents = [];
let currentView = 'calendar';
let calendarMode = 'month';      // 'month' | 'week'
let cursorDate = new Date();     // reference date for nav
const DATA_SOURCE = './events.json';
// === Venue timezone (Los Angeles) ===
const VENUE_TZ = 'America/Los_Angeles';
// Use the same tz for all displayed times
const tz = VENUE_TZ;
const url = new URL(window.location.href); // ensure string param
/* Genres state */
let allGenres = [];
const selectedGenres = new Set();

/* =============== Helpers =============== */
const qs = function(sel){ return document.querySelector(sel); };
const qsa = function(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); };
const safe = function(s){ return (s != null ? s : '').toString(); };

function parseDate(d){
  var dt = new Date(d);
  return isNaN(dt) ? null : dt;
}
function parseGenresField(g){
  if(Array.isArray(g)) return g.map(function(s){return safe(s).trim();}).filter(Boolean);
  return safe(g).split(',').map(function(s){return s.trim();}).filter(Boolean)
    .reduce(function(acc,tag){
      var k = tag.toLowerCase();
      if(acc.map(function(t){return t.toLowerCase();}).indexOf(k) === -1) acc.push(tag);
      return acc;
    },[]);
}
function fmtTZ(dt, opts){
  return new Intl.DateTimeFormat('en-US', Object.assign({ timeZone: VENUE_TZ }, opts)).format(dt);
}
function fmtDate(dt){
  if(!dt) return '';
  return dt.toLocaleString('en-US',{
    weekday:'long', year:'numeric', month:'long', day:'numeric',
    hour:'2-digit', minute:'2-digit', timeZone: tz,
  });
}
// Returns YYYY-MM-DD in the venue timezone (not UTC)
function ymd(dt){
  if (!dt) return '';
  return new Intl.DateTimeFormat('en-CA', {
    timeZone: VENUE_TZ,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(dt); // e.g. 2025-09-10
}
function stageColor(stage){
  var s = safe(stage); var hash=0; for(var i=0;i<s.length;i++){hash=(hash*31+s.charCodeAt(i))>>>0}
  var hue = hash % 360; return 'hsl(' + hue + ' 55% 45% / 1)';
}
function slugify(str){return safe(str).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}
function eventId(ev){ return ymd(ev.date) + '-' + slugify(ev.title) }

/* Calendar helpers */
function firstDayOfGrid(y,m){ var first=new Date(y,m,1); var weekday=(first.getDay()+6)%7; var start=new Date(y,m,1-weekday); start.setHours(0,0,0,0); return start; }
function startOfWeek(d){ var x=new Date(d); var wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
function endOfWeek(s){ var e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
function formatWeekRange(start, end){
  const sameMonth = (fmtTZ(start,{month:'long'}) === fmtTZ(end,{month:'long'})) &&
                    (fmtTZ(start,{year:'numeric'}) === fmtTZ(end,{year:'numeric'}));
  if (sameMonth) {
    return `${fmtTZ(start,{month:'long'})} ${fmtTZ(start,{day:'numeric'})}–${fmtTZ(end,{day:'numeric'})}, ${fmtTZ(end,{year:'numeric'})}`;
  } else {
    const p1 = fmtTZ(start,{month:'short',day:'numeric'});
    const p2 = fmtTZ(end,{month:'short',day:'numeric',year:'numeric'});
    return `${p1} – ${p2}`;
  }
}

/* URL sync */
function setParam(key,val){
  if(val!==null && val!=='') url.searchParams.set(key,val); else url.searchParams.delete(key);
  history.replaceState(null,'',url.toString());
}

/* Debounce */
function debounce(fn,ms){ var t; ms = ms||250; return function(){ var args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,args); }, ms); }; }

/* =============== Loading =============== */
async function loadEvents(){
  try{
    const res = await fetch(DATA_SOURCE+'?_='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(!data || !Array.isArray(data.events)) throw new Error('Invalid data format');

    events = data.events
      .map(function(e){
        var sourceGenres = (e.genres != null ? e.genres : e.genre);
        var genresArr = parseGenresField(sourceGenres);
        return {
          title: safe(e.title),
          stage: safe(e.stage),
          description: safe(e.description),
          email: safe(e.email) || '',
          instagram: safe(e.instagram) || '',
          website: safe(e.website) || '',
          duration: safe(e.duration),
          image: safe(e.image),
          date: parseDate(e.date),
          genres: genresArr
        };
      })
      .filter(function(e){ return e.date; });

    events.sort(function(a,b){ return a.date-b.date; });
    filteredEvents = events.slice();

    var tzEl = qs('#tzLabel'); tzEl.textContent = 'Times shown in ' + tz; tzEl.classList.remove('hidden');
    if(data.lastUpdated){
      var d = new Date(data.lastUpdated);
      var el = qs('#lastUpdated');
      el.textContent = 'Last updated: ' + d.toLocaleString();
      el.classList.remove('hidden');
    }

    populateFilterOptions();
    initFromURL();

    qs('#loadingMessage').classList.add('hidden');
    qs('#controls').classList.remove('hidden');

    (currentView==='calendar' ? qs('#calendarView') : qs('#listView')).classList.remove('hidden');
  }catch(err){
    console.error(err);
    qs('#loadingMessage').classList.add('hidden');
    qs('#errorMessage').classList.remove('hidden');
  }
}

/* =============== Filters / Search =============== */
function populateFilterOptions(){
  var stages = Array.from(new Set(events.map(function(e){return e.stage;}).filter(Boolean))).sort();
  var stageSel = qs('#stageFilter');
  stageSel.innerHTML = '<option value="">Stage</option>';
  stages.forEach(function(s){
    var o=document.createElement('option'); o.value=s; o.textContent=s; stageSel.appendChild(o);
  });

  // genres
  var seen = {}; allGenres = [];
  events.forEach(function(e){
    (e.genres||[]).forEach(function(g){
      var k=g.toLowerCase(); if(!seen[k]){ seen[k]=1; allGenres.push(g); }
    });
  });
  allGenres.sort(function(a,b){ return a.localeCompare(b,undefined,{sensitivity:'base'}); });
  buildGenreList(allGenres);
  updateGenreButtonLabel();
}

function buildGenreList(list){
  var cont = qs('#genreList');
  cont.innerHTML = '';
  list.forEach(function(g){
    var id = 'g-' + slugify(g);
    var row = document.createElement('label');
    row.className = 'multi-item';
    row.innerHTML = '<input type="checkbox" id="'+id+'" value="'+g+'"><span>'+g+'</span>';
    cont.appendChild(row);
  });
  cont.querySelectorAll('input[type="checkbox"]').forEach(function(cb){
    cb.checked = selectedGenres.has(cb.value.toLowerCase());
    cb.addEventListener('change', function(){
      var key = cb.value.toLowerCase();
      if(cb.checked) selectedGenres.add(key); else selectedGenres.delete(key);
      updateGenreButtonLabel();
      applyFilters();
    });
  });
}
function updateGenreButtonLabel(){
  var btnLabel = qs('#genreBtnLabel');
  var count = selectedGenres.size;
  if(count===0){ btnLabel.textContent = 'Genre (any)'; }
  else if(count===1){
    var key = Array.from(selectedGenres)[0];
    var disp = allGenres.find(function(g){return g.toLowerCase()===key;}) || key;
    btnLabel.textContent = disp;
  } else {
    btnLabel.innerHTML = Array.from(selectedGenres).map(function(k){
      var disp = allGenres.find(function(g){return g.toLowerCase()===k;}) || k;
      return '<span class="pill">'+disp+'</span>';
    }).join(' ');
  }
  setParam('genres', count? Array.from(selectedGenres).join(',') : null);
}

function applyFilters(){
  var q = safe(qs('#searchInput').value).toLowerCase();
  var stage = qs('#stageFilter').value;
  var dateF = qs('#dateFilter').value;

  setParam('q', q || null);
  setParam('stage', stage || null);
  setParam('date', dateF || null);
  setParam('genres', selectedGenres.size? Array.from(selectedGenres).join(',') : null);

  var now = new Date(); now.setHours(0,0,0,0);
  var weekEnd = new Date(now.getTime()+7*86400000);

  filteredEvents = events.filter(function(e){
    var txt = (e.title+' '+e.description+' '+e.stage+' '+(e.genres||[]).join(' ')).toLowerCase();
    var mQ = !q || txt.indexOf(q) !== -1;
    var mS = !stage || e.stage===stage;
    var mG = selectedGenres.size===0 || (e.genres||[]).some(function(g){return selectedGenres.has(g.toLowerCase());});
    var mD = true;
    if(dateF==='today'){ mD = ymd(e.date)===ymd(new Date()); }
    else if(dateF==='this-week'){ mD = e.date >= now && e.date < weekEnd; }
    else if(dateF==='this-month'){ var t=new Date(); mD = e.date.getMonth()===t.getMonth() && e.date.getFullYear()===t.getFullYear(); }
    return mQ && mS && mG && mD;
  });

  if(currentView==='list') generateEventCards(); else generateCalendar();
}

var debouncedFilter = debounce(applyFilters, 200);

function clearFilters(){
  qs('#searchInput').value = '';
  qs('#stageFilter').value = '';
  qs('#dateFilter').value = '';
  selectedGenres.clear();
  qsa('#genreList input[type="checkbox"]').forEach(function(cb){ cb.checked=false; });
  updateGenreButtonLabel();
  applyFilters();
}

/* =============== Calendar Render =============== */
function generateCalendar(){
  var grid = qs('#calendarGrid'); grid.innerHTML = '';

  if(calendarMode==='month'){
    grid.classList.remove('week');
    var y = cursorDate.getFullYear(), m = cursorDate.getMonth();
    qs('#monthLabel').textContent = fmtTZ(new Date(y, m, 1), { month:'long', year:'numeric' });

    var daysOfWeek = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
    daysOfWeek.forEach(function(d){
      var h = document.createElement('div'); h.className='calendar-header'; h.textContent=d; grid.appendChild(h);
    });

    var start = firstDayOfGrid(y,m);
    var today = new Date(); today.setHours(0,0,0,0);

    for(var i=0;i<42;i++){
      var dayDate = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
      var cell = document.createElement('div');
      cell.className = 'calendar-day' + (dayDate.getMonth()!==m ? ' muted' : '') + (ymd(dayDate)===ymd(today)?' today':'');

      var dn = document.createElement('div'); dn.className='day-number'; dn.textContent=dayDate.getDate(); cell.appendChild(dn);

      var dayEvents = filteredEvents.filter(function(e){ return ymd(e.date)===ymd(dayDate); });
      dayEvents.forEach(function(ev){
        var it = document.createElement('div');
        it.className='event-item';
        it.textContent = ev.title;
        if(ev.stage){
          var chip = document.createElement('span'); chip.className='event-chip'; chip.style.background = stageColor(ev.stage); chip.textContent = ev.stage;
          it.appendChild(chip);
        }
        it.onclick = function(){ openEventModal(ev); };
        cell.appendChild(it);
      });

      grid.appendChild(cell);
    }
  } else { // week mode
    grid.classList.add('week');
    var startW = startOfWeek(cursorDate);
    var endW = endOfWeek(startW);
    qs('#monthLabel').textContent = 'Week of ' + formatWeekRange(startW,endW);

    for(var j=0;j<7;j++){
      var d = new Date(startW); d.setDate(startW.getDate()+j);
      var section = document.createElement('div');
      section.className = 'week-day';
      var head = document.createElement('div');
      head.className = 'week-head';
      head.innerHTML =`<span>${fmtTZ(d,{weekday:'short'})}</span>`+`<span>${fmtTZ(d,{month:'short', day:'numeric'})}</span>`;
      section.appendChild(head);
      var dayEventsW = filteredEvents.filter(function(e){ return ymd(e.date)===ymd(d); });
      if(dayEventsW.length===0){
        var empty = document.createElement('div');
        empty.style.opacity = .6;
        empty.style.fontSize = '13px';
        empty.textContent = 'No events';
        section.appendChild(empty);
      } else {
        dayEventsW.forEach(function(ev){
          var it = document.createElement('div');
          it.className='event-item';
          it.style.margin='4px 0';
          it.textContent = ev.title;
          if(ev.stage){
            var chip = document.createElement('span'); chip.className='event-chip'; chip.style.background = stageColor(ev.stage); chip.textContent = ev.stage;
            it.appendChild(chip);
          }
          it.onclick = function(){ openEventModal(ev); };
          section.appendChild(it);
        });
      }

      grid.appendChild(section);
    }
  }
}

function prevSpan(){
  if(calendarMode==='month'){
    cursorDate = new Date(cursorDate.getFullYear(), cursorDate.getMonth()-1, 1);
  } else {
    cursorDate = new Date(cursorDate.getFullYear(), cursorDate.getMonth(), cursorDate.getDate()-7);
  }
  setParam('cursor', ymd(cursorDate));
  generateCalendar();
}
function nextSpan(){
  if(calendarMode==='month'){
    cursorDate = new Date(cursorDate.getFullYear(), cursorDate.getMonth()+1, 1);
  } else {
    cursorDate = new Date(cursorDate.getFullYear(), cursorDate.getMonth(), cursorDate.getDate()+7);
  }
  setParam('cursor', ymd(cursorDate));
  generateCalendar();
}
function goToToday(){
  cursorDate = new Date();
  setParam('cursor', ymd(cursorDate));
  generateCalendar();
}

/* =============== List Render =============== */
function generateEventCards(){
  var wrap = qs('#eventCards'); wrap.innerHTML='';
  filteredEvents.forEach(function(ev){
    var card = document.createElement('div');
    card.className='event-card';
    var imgSrc = ev.image || '';
    var fallback = 'https://via.placeholder.com/800x420/9b59b6/ffffff?text='+encodeURIComponent(ev.title);
    var websiteHref = ev.website ? (ev.website.indexOf('http')===0 ? ev.website : 'https://'+ev.website) : '';
    var gcalUrl = googleCalendarUrl(ev);
    var ics = buildICS(ev);

    card.innerHTML = ''
      + '<img src="'+imgSrc+'" alt="'+ev.title+'" class="event-image" loading="lazy" onerror="this.src=\''+fallback+'\'">'
      + '<div class="event-content">'
      +   '<div class="event-title">'+ev.title+(ev.stage ? ' <span class="event-chip" style="background:'+stageColor(ev.stage)+'">'+ev.stage+'</span>' : '')+'</div>'
      +   '<div class="event-date">'+fmtDate(ev.date)+'</div>'
      +   '<div class="event-description">'+(ev.description||'')+'</div>'
      +   '<div class="event-details">'
      +     '<div class="detail-item"><span class="detail-label">Genres:</span><span class="detail-value">'+((ev.genres||[]).join(', ') || '—')+'</span></div>'
      +     '<div class="detail-item"><span class="detail-label">Duration:</span><span class="detail-value">'+(ev.duration || '—')+'</span></div>'
      +   '</div>'
      +   '<div class="links">'
      +     (ev.email ? '<a class="link" href="mailto:'+ev.email+'">Email</a>' : '')
      +     (ev.instagram ? '<a class="link" target="_blank" rel="noopener" href="https://instagram.com/'+ev.instagram.replace('@','')+'">Instagram</a>' : '')
      +     (websiteHref ? '<a class="link" target="_blank" rel="noopener" href="'+websiteHref+'">Website</a>' : '')
      +     '<a class="link" target="_blank" rel="noopener" href="'+gcalUrl+'">Add to Google Calendar</a>'
      +     '<a class="link" href="'+ics+'" download="'+eventId(ev)+'.ics">Download .ics</a>'
      +     '<button class="link" type="button" data-id="'+eventId(ev)+'">Details</button>'
      +   '</div>'
      + '</div>';

    card.querySelector('[data-id]').addEventListener('click',function(){ openEventModal(ev); });
    card.querySelector('.event-image').addEventListener('click', function(){ openEventModal(ev); });

    wrap.appendChild(card);
  });

  var now = new Date();
  var idx = filteredEvents.findIndex(function(e){return e.date>=now;});
  if(idx>=0){
    var node = wrap.children[idx];
    if(node) node.scrollIntoView({behavior:'smooth',block:'center'});
  }
}

/* =============== Modal (includes image) =============== */
function openEventModal(ev){
  var mb = qs('#modalBody'), md = qs('#modalBackdrop'), mt = qs('#modalTitle');
  mt.textContent = ev.title;
  var websiteHref = ev.website ? (ev.website.indexOf('http')===0 ? ev.website : 'https://'+ev.website) : '';
  var gcalUrl = googleCalendarUrl(ev);
  var ics = buildICS(ev);
  var img = ev.image || '';
  var fallback = 'https://via.placeholder.com/800x420/9b59b6/ffffff?text='+encodeURIComponent(ev.title);

  mb.innerHTML = ''
   + '<div class="modal-grid">'
   +   '<div><img class="modal-img" src="'+img+'" alt="'+ev.title+'" onerror="this.src=\''+fallback+'\'"></div>'
   +   '<div>'
   +     '<p><strong>Date:</strong> '+fmtDate(ev.date)+'</p>'
   +     '<p><strong>Stage:</strong> '+(ev.stage || '—')+'</p>'
   +     '<p><strong>Genres:</strong> '+((ev.genres||[]).join(', ') || '—')+'</p>'
   +     '<p><strong>Duration:</strong> '+(ev.duration || '—')+'</p>'
   +     '<p class="event-description" style="margin-top:8px">'+(ev.description || '')+'</p>'
   +     '<div class="links" style="margin-top:10px">'
   +       (ev.email ? '<a class="link" href="mailto:'+ev.email+'">Email</a>' : '')
   +       (ev.instagram ? '<a class="link" target="_blank" rel="noopener" href="https://instagram.com/'+ev.instagram.replace('@','')+'">Instagram</a>' : '')
   +       (websiteHref ? '<a class="link" target="_blank" rel="noopener" href="'+websiteHref+'">Website</a>' : '')
   +       '<a class="link" target="_blank" rel="noopener" href="'+gcalUrl+'">Google Calendar</a>'
   +       '<a class="link" href="'+ics+'" download="'+eventId(ev)+'.ics">Download .ics</a>'
   +     '</div>'
   +   '</div>'
   + '</div>';

  md.style.display='flex';
  qs('#modalClose').focus();
}
function closeModal(){ qs('#modalBackdrop').style.display='none'; }

/* =============== Calendar Links =============== */
function googleCalendarUrl(ev){
  var start = isoForGCal(ev.date);
  var end = isoForGCal(endFromDuration(ev.date, ev.duration));
  var text = encodeURIComponent(ev.title);
  var details = encodeURIComponent(ev.description||'');
  var location = encodeURIComponent(ev.stage||'Clubhouse');
  return 'https://calendar.google.com/calendar/render?action=TEMPLATE&text='+text+'&dates='+start+'/'+end+'&details='+details+'&location='+location;
}
function isoForGCal(dt){ var z=new Date(dt); return z.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z'); }
function endFromDuration(start, dur){
  var s = new Date(start);
  if(!dur) { s.setHours(s.getHours()+1); return s; }
  var m = /(\d+)\s*h(?:ours?)?|\b(\d+)\s*m(?:in)?/gi;
  var hours=0, mins=0, match;
  while((match=m.exec(dur))!==null){ if(match[1]) hours += parseInt(match[1],10); if(match[2]) mins += parseInt(match[2],10); }
  if(hours===0 && mins===0){ hours=1; }
  s.setHours(s.getHours()+hours); s.setMinutes(s.getMinutes()+mins); return s;
}
function buildICS(ev){
  var uid = eventId(ev)+'@clubhousecal';
  var dtStart = formatICS(ev.date);
  var dtEnd = formatICS(endFromDuration(ev.date, ev.duration));
  var desc = (ev.description||'').replace(/\n/g,'\\n');
  var loc = (ev.stage||'Clubhouse').replace(/\n/g,'\\n');
  var body =
'BEGIN:VCALENDAR\n'
+'VERSION:2.0\n'
+'PRODID:-//clubhousecal//EN\n'
+'BEGIN:VEVENT\n'
+'UID:'+uid+'\n'
+'DTSTAMP:'+formatICS(new Date())+'\n'
+'DTSTART:'+dtStart+'\n'
+'DTEND:'+dtEnd+'\n'
+'SUMMARY:'+ev.title+'\n'
+'DESCRIPTION:'+desc+'\n'
+'LOCATION:'+loc+'\n'
+'END:VEVENT\n'
+'END:VCALENDAR';
  return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(body);
}
function pad(n){ return String(n).padStart(2,'0'); }
function formatICS(d){ var z=new Date(d); return z.getUTCFullYear()+pad(z.getUTCMonth()+1)+pad(z.getUTCDate())+'T'+pad(z.getUTCHours())+pad(z.getUTCMinutes())+'00Z'; }

/* =============== View + Mode Switching =============== */
function switchView(view){
  currentView = view;
  setParam('view', view);
  var cal = qs('#calendarView'), list = qs('#listView');
  var calBtn = qs('#calendarViewBtn'), listBtn = qs('#listViewBtn');

  if(view==='calendar'){
    document.body.classList.remove('is-list');
    cal.classList.remove('hidden'); list.classList.add('hidden');
    calBtn.classList.add('active'); listBtn.classList.remove('active');
    generateCalendar();
  }else{
    document.body.classList.add('is-list');
    list.classList.remove('hidden'); cal.classList.add('hidden');
    listBtn.classList.add('active'); calBtn.classList.remove('active');
    generateEventCards();
  }
}
function setCalendarMode(mode){
  calendarMode = mode;
  setParam('mode', mode);
  qs('#modeMonthBtn').classList.toggle('active', mode==='month');
  qs('#modeWeekBtn').classList.toggle('active', mode==='week');
  generateCalendar();
}

/* =============== Wiring =============== */
function setupListeners(){
  qs('#listViewBtn').onclick = function(){ switchView('list'); };
  qs('#calendarViewBtn').onclick = function(){ switchView('calendar'); };
  qs('#searchInput').addEventListener('input', debouncedFilter);
  qs('#stageFilter').addEventListener('change', applyFilters);
  qs('#dateFilter').addEventListener('change', applyFilters);
  qs('#clearFiltersBtn').addEventListener('click', clearFilters);

  // nav
  qs('#prevSpanBtn').onclick = prevSpan;
  qs('#nextSpanBtn').onclick = nextSpan;
  qs('#todayBtn').onclick = goToToday;

  // mode buttons (segmented)
  qs('#modeMonthBtn').onclick = function(){ setCalendarMode('month'); };
  qs('#modeWeekBtn').onclick = function(){ setCalendarMode('week'); };

  // modal
  qs('#modalClose').onclick = closeModal;
  qs('#modalBackdrop').addEventListener('click', function(e){ if(e.target.id==='modalBackdrop') closeModal(); });
  document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeModal(); });

  // genre multi
  var multi = qs('#genreMulti'); var btn = qs('#genreBtn'); var panel = qs('#genrePanel'); var search = qs('#genreSearch');
  btn.addEventListener('click', function(){
    var open = multi.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    if(open) search.focus();
  });
  document.addEventListener('click', function(e){
    if(!multi.contains(e.target)){ multi.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });
  search.addEventListener('input', function(){
    var q = search.value.toLowerCase();
    var filtered = allGenres.filter(function(g){return g.toLowerCase().indexOf(q)!==-1;});
    buildGenreList(filtered);
  });

  // Mobile: filters drawer toggle
  var filters = qs('#filters');
  var toggle = qs('#filtersToggleBtn');
  if(toggle){
    toggle.addEventListener('click', function(){
      var isCollapsed = filters.classList.toggle('collapsed');
      toggle.setAttribute('aria-expanded', String(!isCollapsed));
    });
  }
}

/* =============== URL -> UI init =============== */
function initFromURL(){
  var v = url.searchParams.get('view');
  if(v==='list' || v==='calendar') currentView=v;
  else if(window.innerWidth <= 768) currentView='list';

  var m = url.searchParams.get('mode');
  if(m==='week' || m==='month') calendarMode=m;
  else if(window.innerWidth <= 768) calendarMode='week';
  else calendarMode='month';

  var c = url.searchParams.get('cursor');
  cursorDate = c ? new Date(c) : new Date();

  var qVal = url.searchParams.get('q') || '';
  var stageVal = url.searchParams.get('stage') || '';
  var dateVal = url.searchParams.get('date') || '';
  qs('#searchInput').value = qVal;
  qs('#stageFilter').value = stageVal;
  qs('#dateFilter').value = dateVal;

  var gParam = url.searchParams.get('genres');
  if(gParam){
    gParam.split(',').forEach(function(k){ selectedGenres.add(k.toLowerCase()); });
  }
  updateGenreButtonLabel();
  buildGenreList(allGenres);

  setupListeners();
  switchView(currentView);
  setCalendarMode(calendarMode);
  applyFilters();

  if(window.innerWidth <= 768){ qs('#filters').classList.add('collapsed'); }
  else { qs('#filters').classList.remove('collapsed'); }
}

/* =============== Boot =============== */
document.addEventListener('DOMContentLoaded', loadEvents);
</script>
</body>
</html>
